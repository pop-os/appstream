From 8889da6a054b567aa17e0c305a88a2df0a97de99 Mon Sep 17 00:00:00 2001
From: Matthias Klumpp <matthias@tenstral.net>
Date: Fri, 5 Feb 2021 02:45:43 +0100
Subject: [PATCH] qt: Return better errors in AppStream::Metadata

---
 qt/metadata.cpp | 31 ++++++++++++++++++++++++++-----
 qt/metadata.h   |  5 +++++
 qt/pool.h       | 10 +++++-----
 3 files changed, 36 insertions(+), 10 deletions(-)

diff --git a/qt/metadata.cpp b/qt/metadata.cpp
index f3dff2c4..646cf4f0 100644
--- a/qt/metadata.cpp
+++ b/qt/metadata.cpp
@@ -54,6 +54,7 @@ class AppStream::MetadataData : public QSharedData {
         return m_metadata;
     }
 
+    QString lastError;
     AsMetadata* m_metadata;
 };
 
@@ -139,7 +140,11 @@ AppStream::Metadata::MetadataError AppStream::Metadata::parseFile(const QString&
     as_metadata_parse_file(d->m_metadata, gFile, (AsFormatKind) format, &error);
 
     if (error != nullptr) {
-        return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        d->lastError = QString::fromUtf8(error->message);
+        if (error->domain == AS_METADATA_ERROR)
+            return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        else
+            return AppStream::Metadata::MetadataErrorFailed;
     }
 
     return AppStream::Metadata::MetadataErrorNoError;
@@ -151,7 +156,11 @@ AppStream::Metadata::MetadataError AppStream::Metadata::parse(const QString& dat
     as_metadata_parse(d->m_metadata, qPrintable(data), (AsFormatKind) format, &error);
 
     if (error != nullptr) {
-        return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        d->lastError = QString::fromUtf8(error->message);
+        if (error->domain == AS_METADATA_ERROR)
+            return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        else
+            return AppStream::Metadata::MetadataErrorFailed;
     }
 
     return AppStream::Metadata::MetadataErrorNoError;
@@ -163,7 +172,11 @@ AppStream::Metadata::MetadataError AppStream::Metadata::parseDesktopData(const Q
     as_metadata_parse_desktop_data(d->m_metadata, qPrintable(data), qPrintable(cid), &error);
 
     if (error != nullptr) {
-        return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        d->lastError = QString::fromUtf8(error->message);
+        if (error->domain == AS_METADATA_ERROR)
+            return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        else
+            return AppStream::Metadata::MetadataErrorFailed;
     }
 
     return AppStream::Metadata::MetadataErrorNoError;
@@ -211,7 +224,11 @@ AppStream::Metadata::MetadataError AppStream::Metadata::saveMetainfo(const QStri
     as_metadata_save_metainfo(d->m_metadata, qPrintable(fname), (AsFormatKind) format, &error);
 
     if (error != nullptr) {
-        return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        d->lastError = QString::fromUtf8(error->message);
+        if (error->domain == AS_METADATA_ERROR)
+            return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        else
+            return AppStream::Metadata::MetadataErrorFailed;
     }
 
     return AppStream::Metadata::MetadataErrorNoError;
@@ -228,7 +245,11 @@ AppStream::Metadata::MetadataError AppStream::Metadata::saveCollection(const QSt
     as_metadata_save_collection(d->m_metadata, qPrintable(collection), (AsFormatKind) format, &error);
 
     if (error != nullptr) {
-        return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        d->lastError = QString::fromUtf8(error->message);
+        if (error->domain == AS_METADATA_ERROR)
+            return static_cast<AppStream::Metadata::MetadataError>(error->code);
+        else
+            return AppStream::Metadata::MetadataErrorFailed;
     }
 
     return AppStream::Metadata::MetadataErrorNoError;
diff --git a/qt/metadata.h b/qt/metadata.h
index 814efb55..d9961766 100644
--- a/qt/metadata.h
+++ b/qt/metadata.h
@@ -132,6 +132,11 @@ class APPSTREAMQT_EXPORT Metadata {
         QString architecture() const;
         void setArchitecture(const QString& architecture);
 
+        /**
+         * \return The last error message received.
+         */
+        QString lastError() const;
+
     private:
         QSharedDataPointer<MetadataData> d;
 };
diff --git a/qt/pool.h b/qt/pool.h
index c76324a3..4ff57650 100644
--- a/qt/pool.h
+++ b/qt/pool.h
@@ -73,9 +73,9 @@ Q_OBJECT
 
         /**
          * \return true on success. False on failure
-	 *
-	 * Loads all available metadata and opens the cache. In case of an error,
-	 * \sa lastError() will contain the error message.
+         *
+         * Loads all available metadata and opens the cache. In case of an error,
+         * \sa lastError() will contain the error message.
          */
         bool load();
 
@@ -91,10 +91,10 @@ Q_OBJECT
          */
         void clear();
 
-	/**
+        /**
          * \return The last error message received.
          */
-	QString lastError() const;
+        QString lastError() const;
 
         /**
          * Add a component to the pool.
